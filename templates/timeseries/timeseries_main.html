{% extends "datasets/base.html" %}

{% load i18n %}
{% load humanize %}
{% load uni_form %}
{% load pagination_tags %}
{% load truncate_filter %}
{% load tagging_tags %}
{% load extra_tagging_tags %}

{% block head_title %}{% blocktrans %}My Time Series data{% endblocktrans %}{% endblock %}

{% block extra_head %}
<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/shCore.css"/> 
<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/shThemeDefault.css"/>
<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/shTreeDemo.css"/>  
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/highcharts.js"></script>
<script type="text/javascript">
   $(document).ready(function() {
   var chart;
   chart = new Highcharts.Chart({
   chart: {
      renderTo: 'container',
      zoomType: 'x'
   },
        title: {
      text: '{{ tserie.title }}'
   },
        subtitle: {
      text: 'Click and drag in the plot area to zoom in'
   },
   xAxis: {
      type: 'datetime',
      maxZoom: 2 * {{ t_serie.getTimeStep }}, 
      title: {
         text: null
      }
   },
   yAxis: {
      title: {
         text: 'Voltage'
      },
      //min: 0.6,
      startOnTick: false,
      showFirstLabel: false
   },
   tooltip: {
      formatter: function() {
         return '<b>'+ (this.point.name || this.series.name) +'</b><br>'+
            Highcharts.dateFormat('%A %B %e %Y', this.x) + ':<br>'+
            'V(t) = '+ Highcharts.numberFormat(this.y, 2) +' mV';
      }
   },
   legend: {
      enabled: false
   },
   plotOptions: {
      area: {
         fillColor: {
            linearGradient: [0, 0, 0, 300],
            stops: [
               [0, 'rgba(255,255,0,0)'],
               [1, 'rgba(0,0,0,0)']
            ]
         },
         lineWidth: 1,
         marker: {
            enabled: false,
            states: {
               hover: {
                  enabled: true,
                  radius: 3
               }
            }
         },
         shadow: false,
         states: {
            hover: {
               lineWidth: 1                  
            }
         }
      }
   },

   series: [{
      type: 'area',
      name: 'Voltage dynamics, V(t)',
      pointInterval: {{ t_serie.getTimeStep }},
      pointStart: Date.UTC({{ t_serie.start_time|date:"Y, m, d" }}),
      data: [
        {{ t_serie.getData }}
      ]
   }]
})
});
</script>
{% endblock %}

{% block body %}

    {% if timeseries %}

        <div class="right_panel">
        {% ifequal t_serie.owner request.user %}
                <div class="friends">
                    {% if t_serie.is_Public %}
                    <h2>{% trans "Privacy" %}</h2>
                    <p>This Time Serie is <b style="color: red">Public</b> and available for other users. Members of this site may explore this Time Serie.</p>
                    {% else %}
                    <h2>{% trans "Shared with:" %}</h2>
                        {% if t_serie.is_Friendly %}
                            <p>All people you know
                            {% if t_serie.shared_with.all %}
                            , and </p>
                                {% for exp_member in t_serie.shared_with.all %}
                                        <span><a href="{% url profile_detail exp_member.username %}" title="{{ exp_member.username }}">{{ exp_member.username }}</a>, </span>
                                {% endfor %}
                            {% else %}
                                .</p>
                            {% endif %}
                        {% else %}
                            {% if t_serie.shared_with.all %}
                                {% for exp_member in t_serie.shared_with.all %}
                                        <span><a href="{% url profile_detail exp_member.username %}" title="{{ exp_member.username }}">{{ exp_member.username }}</a>, </span>
                                {% endfor %}
                            {% else %}
                                <p><b>Nobody</b>. Only YOU can see this Time Serie.</p>
                            {% endif %}
                        {% endif %}
                        <p>Please note, it's always ONLY YOUR exclusive right to MANAGE your Time Series data, changing its properties and privacy settings.</p>
                    {% endif %}
                </div>
        {% endifequal %}

            <div class="friends">
                <h2>{% trans "Linked to" %}</h2>
                {% comment %}
                <h2>{% trans "From Experiments" %}</h2>
                <p>Select an experiment to browse time series data, associated with it. Or push <a href="{% url timeseries_main %}">"View all"</a> to browse all your recorded time series.</p>
                {% endcomment %}
                {% if objs %}
                    <table width="100%">
                        {% for obj in objs %}
                            <tr><td>- <a href="{{ obj.get_absolute_url }}">{{ obj.title|truncate_dot:26|escape }}</a></td></tr>
                        {% endfor %}
                    </table>                    
                {% endif%}
            </div>

            <div class="friends">
                <h2>{% trans "Time Series" %}</h2>
        	        <form id="delete-exprts" method="POST" action="">
                    {% autopaginate timeseries 15 %}
                    <table width="100%">
                        <tr><th>{% trans "No." %}</th><th>{% trans "Owner" %}</th></tr>
                        {% for tserie in timeseries %}
                            <tr>
                                <td>- <a href="{{ tserie.get_absolute_url }}">{{ tserie.title|truncate_dot:10|escape }}</a></td>
                                <td><a href="{% url profile_detail tserie.owner.username %}" title="{{ tserie.owner.username }}">{{ tserie.owner.username }}</a></td>
				                {% ifequal user tserie.owner %}
				                <td align=right><input id="id_serie_choices_{{ tserie.id }}" type="checkbox" value="{{ tserie.id }}" name="serie_choices"/></td>
				                {% endifequal %}
                            </tr>
                        {% endfor %}
                    </table>    
			            <input type="hidden" name="action" value="timeseries_delete"/>
			            <input type="submit" value="delete selected"/>

                	{% paginate %}
                    </form>
            </div>
        </div>

        <div class="left_panel">

        <div class="form-toggle">
            <p>
                <span id="add-timeseries-toggle" onclick="$('#edit-timeseries').hide(); $('#add-from-file').hide(); $('#add-timeseries').toggle();">{% trans "Add Time Serie" %}</span>
                <span id="add-from-file-toggle" onclick="$('#edit-timeseries').hide(); $('#add-timeseries').hide(); $('#add-from-file').toggle();">{% trans "Add Time Series from File" %}</span>
            </p>
            <div id="form-add-timeseries">
                <form class="uniForm" id="add-timeseries" method="POST" action="" style="display:{{ tserie_add_form_status }}">
                    <fieldset class="inlineLabels">
                        {{ tserie_add_form|as_uni_form }}
                        <div class="form_block">
                            <input type="hidden" name="action" value="timeseries_add" />
                            <input type="submit" value="create"/>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div id="form-add-from-file">
                <form class="uniForm" id="add-from-file" method="POST" action="" style="display:{{ add_from_file_status }}">
                    <fieldset class="inlineLabels">
                        {{ add_from_file_form|as_uni_form }}
                        <div class="form_block">
                            <input type="hidden" name="action" value="add_from_file" />
                            <input type="submit" value="parse the file and create time series"/>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>         

        <div class="photo-title">
            <h2>{{ t_serie.title }} {% if not t_serie.isActive %}(DELETED){% endif %}</h2>
        </div>
        <div class="photo-caption">
            <p><b>Description: </b>{{ t_serie.description }}</p>
        </div>
        <div>
            <p><b>Date created: </b>{{ t_serie.date_created }}</p>
        </div>
        <div>
            {% ifnotequal t_serie.owner request.user%}
            <b>Owner: </b>
            <a href="{% url profile_detail t_serie.owner.username %}">{{ t_serie.owner.username }}</a>
            {% endifnotequal %}
        </div>
        <div>
            {% show_tags_for t_serie %}
        </div>

        {% ifequal request.user t_serie.owner %}
            {% with tserie_edit_form as edit_form %}
                {% include "state_machine/edit_details.html" %}
            {% endwith %}

            {% with privacy_form as privacy_form %}
                {% include "state_machine/edit_privacy.html" %}
            {% endwith %}
        {% endifequal %}

        <div id="container" style="width: 700px; height: 300px; margin: 0 auto"></div>

        {% if t_serie.hasMetadata %}
        <h2>{% trans "Metadata" %}</h2>

        {% with t_serie as tree_container %}
        {% ifequal request.user t_serie.owner %}
            {% comment %} PAPA is used to indicate which metadata buttons to render, 
                    depending on object type {% endcomment %}
            {% with "timeseries" as papa %}
                {% include "metadata/section_buttons.html" %}
            {% endwith %}
            <div id="form-add-section" style="padding: 0; margin: 0; display:none">
                {% include "metadata/section_add.html" %}
                <div id="default_properties_area" style="height: 209px; width: 500px; padding-left: 10px; overflow: auto;">
                    {% include "metadata/properties_list.html" %}
                </div>
            </div>
        {% endifequal %}

        <div style="padding: 6px 0px 0px 0px; margin: 0;">
                {% include "metadata/sections_tree.html" %}
            <div id="properties_area" style="width: 515px; padding-left: 210px">
                {% include "metadata/properties_list.html" %}
            </div>
        </div>
        {% endwith %}

        {% else %}
        <p>You don't have metadata assigned to this recording trace. You may want to annotate it by <a href="#" onclick="add_root_section({{ t_serie.id }}, 4)">adding the Metadata</a>.</p>
        {% endif %}

        </div>
  
    {% else %}
        <p>You don't have any timeseries data uploaded. Try by <a href="#" onclick="$('#add-timeseries').toggle();">uploading new time series</a> data now, or <a href="{% url datafile_create %}">upload data</a> in files.</p>
            <div class="form-toggle">
                <div id="form-add-timeseries">
                    <form class="uniForm" id="add-timeseries" method="POST" action="" style="display:none">
                        <fieldset class="inlineLabels">
                            {{ tserie_add_form|as_uni_form }}
                            <div class="form_block">
                                <input type="hidden" name="action" value="timeseries_add" />
                                <input type="submit" value="create"/>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
    {% endif %}
    
{% endblock %}

{% block extra_body %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/clear_selection.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/add_root_section.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/edit_details_privacy.js"></script>

    {% if t_serie.hasMetadata %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.tree.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/delete_metadata_items.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/edit_property.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/add_metadata_items.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/hide_metadata_forms.js"></script>
    {% with t_serie as tree_container %}
        {% include "metadata/load_meta_tree.html" %}
    {% endwith %}
    <script type="text/javascript">
        $(document.getElementById("sections")).ready(function() {
        // 3 - Section
            load_meta_tree(3);
            load_default_meta_tree(3);
            $('#add-property-toggle').click(function() {
                hide_metadata_forms("add-property");
                $('#add-property').toggle();
                return false;
            });
            if ($('#add-property .error').length) {
                $('#add-property').show();
                $('#add-property .error').autoscroll();
            };
        });
    </script>
    {% endif %}
{% endblock %}
