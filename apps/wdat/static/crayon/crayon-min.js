// Copyright (c) 2013, German Neuroinformatics Node (G-Node)
//
// All rights reserved.
//
// Redistribution and use in source and binary forms, with or without
// modification, are permitted under the terms of the BSD License. See
// LICENSE file in the root of the Project.
// ---------- file: version.js ---------- //
// Crayon main module cry
var cry;(function(cry){"use strict";cry.version="v0.3";cry.debug=true})(cry||(cry={}));(function(cry,d3){"use strict";cry.Context=function(){function Context(parent,name,opt){var opt=opt||{};this._svg=parent.append("g");this._svg.attr("class","context").attr("id",name);this._name=name;this._width=Math.round(opt.width||parent.attr("width"));this._height=Math.round(opt.height||parent.attr("height"));this._padd=_adjustUp(opt.padd||20);this._xmin=_adjustDown(opt.xmin||0);this._xmax=_adjustUp(opt.xmax||this._width-(this._padd*2+10));this._ymin=_adjustDown(opt.ymin||0);this._ymax=_adjustUp(opt.ymax||this._height-this._padd*2);this._xticks=opt.xticks!=undefined?Math.round(opt.xticks):10;this._yticks=opt.yticks!=undefined?Math.round(opt.yticks):5;this._xScale=d3.scale.linear();this._xScale.domain([this._xmin,this._xmax]).range([this._padd+10,this._width-this._padd]);this._yScale=d3.scale.linear();this._yScale.domain([this._ymin,this._ymax]).range([this._height-this._padd,this._padd]);this._xAxis=d3.svg.axis();this._xAxis.scale(this._xScale).orient("bottom").ticks(this._xticks);this._xAxisSVG=this._svg.append("g");this._xAxisSVG.attr("transform","translate(0,"+(this._height-this._padd)+")").attr("class","axis").call(this._xAxis);this._yAxis=d3.svg.axis();this._yAxis.scale(this._yScale).orient("left").ticks(this._yticks);this._yAxisSVG=this._svg.append("g");this._yAxisSVG.attr("transform","translate("+(this._padd+10)+",0)").attr("class","axis").call(this._yAxis);this._defs=this._svg.selectAll("defs");if(this._defs.empty())this._defs=this._svg.append("defs");this._onselect=opt.onselect;this.initSelection()}Context.prototype.svg=function(){return this._svg};Context.prototype.defs=function(){return this._defs};Context.prototype.name=function(){return this._name};Context.prototype.xmin=function(xmin){if(xmin!==undefined){this._xmin=_adjustDown(xmin);this.redraw();return this}return this._xmin};Context.prototype.xmax=function(xmax){if(xmax!==undefined){this._xmax=_adjustUp(xmax);this.redraw();return this}return this._xmax};Context.prototype.ymin=function(ymin){if(ymin!==undefined){this._ymin=_adjustDown(ymin);this.redraw();return this}return this._ymin};Context.prototype.ymax=function(ymax){if(ymax!==undefined){this._ymax=_adjustUp(ymax);this.redraw();return this}return this._ymax};Context.prototype.xticks=function(xticks){if(xticks!==undefined){this._xticks=Math.round(xticks);this.redraw();return this}return this._xticks};Context.prototype.yticks=function(yticks){if(yticks!==undefined){this._yticks=Math.round(yticks);this.redraw();return this}return this._yticks};Context.prototype.width=function(width){if(width!==undefined){this._width=Math.round(width);this.redraw();return this}return this._width};Context.prototype.height=function(height){if(height!==undefined){this._height=Math.round(height);this.redraw();return this}return this._height};Context.prototype.onselect=function(onselect){if(onselect!==undefined){this._onselect=onselect;this.redraw();return this}return this._onselect};Context.prototype.options=function(opt){if(opt){if(opt.hasOwnProperty("width"))this._width=Math.round(opt.width);if(opt.hasOwnProperty("height"))this._height=Math.round(opt.height);if(opt.hasOwnProperty("xmin"))this._xmin=_adjustDown(opt.xmin);if(opt.hasOwnProperty("xmax"))this._xmax=_adjustUp(opt.xmax);if(opt.hasOwnProperty("ymin"))this._ymin=_adjustDown(opt.ymin);if(opt.hasOwnProperty("ymax"))this._ymax=_adjustUp(opt.ymax);if(opt.hasOwnProperty("xticks"))this._xticks=Math.round(opt.xticks);if(opt.hasOwnProperty("yticks"))this._yticks=Math.round(opt.yticks);this.redraw()}return this};Context.prototype.xScale=function(val){return this._xScale(val)};Context.prototype.yScale=function(val){return this._yScale(val)};Context.prototype.clear=function(){this._svg.selectAll(".plot").remove();return this};Context.prototype.redraw=function(){this._xScale.domain([this._xmin,this._xmax]).range([this._padd+10,this._width-this._padd]);this._yScale.domain([this._ymin,this._ymax]).range([this._height-this._padd,this._padd]);this._xAxis.scale(this._xScale).ticks(this._xticks);this._xAxisSVG.attr("transform","translate(0,"+(this._height-this._padd)+")").call(this._xAxis);this._yAxis.scale(this._yScale).ticks(this._yticks);this._yAxisSVG.attr("transform","translate("+(this._padd+10)+",0)").call(this._yAxis);this.initSelection();return this};Context.prototype.initSelection=function(){if(this._onselect){if(!this._brush)this._brush=d3.svg.brush();this._svg.attr("class","context brush").attr("style","pointer-events: all;");this._brush=d3.svg.brush();this._brush.x(this._xScale).on("brushend",this.onBrush());this._svg.call(this._brush);this._svg.selectAll(".background, .extent, .resize rect").attr("y",this._padd).attr("height",this._height-2*this._padd)}else{if(this._brush){this._brush.on("brushend",null);this._brush=undefined;this._svg.attr("class","context").attr("style","");this._svg.selectAll(".background, .extent, .resize rect").remove()}}};Context.prototype.onBrush=function(){var that=this,last=[this.xmin(),this.xmax()];return function(){var act=that.onselect(),ext=that._brush.extent(),x1pix=that.xScale(ext[0]),x2pix=that.xScale(ext[1]),diff=x2pix-x1pix;if(diff<1){ext[0]=that.xmin();ext[1]=that.xmax()}if(typeof act=="function"&&(ext[0]!=last[0]||ext[1]!=last[1])){act(ext[0],ext[1]);last=ext}}};function _adjustUp(val){var x=val;if(Math.abs(x)>0){x=Math.ceil(x)}return x}function _adjustDown(val){var x=val;if(Math.abs(x)>0){x=Math.floor(x)}return x}return Context}()})(cry||(cry={}),d3);(function(cry,d3,$){var CryBus;"use strict";cry.PlotManager=function(){function PlotManager(svg){if(typeof svg==="string")this._svg=d3.select("#"+svg);else this._svg=svg;this._bus=new CryBus;this._bus.subscribe("slice",this._renderOnSlice());this._renderer={};this._contexts={};this._sources=[];this._width=this._svg.attr("width");this._height=this._svg.attr("height");this._default;this._borders=null;this._selconfig={width:this._width,height:100,yticks:2,onselect:this._onselect()};this._selcontext=new cry.Context(this._svg,"select",this._selconfig);this._selcontext.svg().attr("transform","translate(0,"+(this._height-this._selconfig.height)+")")}PlotManager.prototype.plot=function(){var conf,source,context,border,renderer,i;if(this._borders){conf=$.extend(true,{},this._borders)}else{conf={xmin:0,xmax:0,ymin:0,ymax:0};for(i in this._sources){source=this._sources[i].source;border=source.dataBorders();if(border.xmin<conf.xmin)conf.xmin=border.xmin;if(border.xmax>conf.xmax)conf.xmax=border.xmax;if(border.ymin<conf.ymin)conf.ymin=border.ymin;if(border.ymax>conf.ymax)conf.ymax=border.ymax}this._borders=$.extend(true,{},conf)}for(i in this._contexts){this._contexts[i].clear().options(this._borders)}this._selcontext.clear().options(this._borders);for(i in this._sources){source=this._sources[i];context=this._contexts[source.context];renderer=this._renderer[source.renderer];renderer.render(context,source.source);if(context.name()==this._default){renderer.render(this._selcontext,source.source)}}};PlotManager.prototype.plotSlice=function(xmin,xmax){var conf,source,border,i;if(this._borders){conf=$.extend(true,{},this._borders)}else{conf={xmin:0,xmax:0,ymin:0,ymax:0};for(i in this._sources){source=this._sources[i].source;border=source.dataBorders();if(border.xmin<conf.xmin)conf.xmin=border.xmin;if(border.xmax>conf.xmax)conf.xmax=border.xmax;if(border.ymin<conf.ymin)conf.ymin=border.ymin;if(border.ymax>conf.ymax)conf.ymax=border.ymax}this._borders=$.extend(true,{},conf)}conf.xmin=xmin;conf.xmax=xmax;for(i in this._contexts){this._contexts[i].clear().options(conf)}for(i in this._sources){this._sources[i].source.slice(xmin,xmax,this._sliceNotify())}};PlotManager.prototype.createContext=function(name,options){var ncontext,i,height,opt,k;if(name&&!this._contexts[name]){ncontext=1;for(i in this._contexts){this._contexts[i].clear();ncontext+=1}height=(this._height-this._selconfig.height)/ncontext;for(i in this._contexts){this._contexts[i].height(height)}opt=options||{};if(!this._default||opt.isdefalt)this._default=name;opt.width=this._width;opt.height=height;this._contexts[name]=new cry.Context(this._svg,name,opt);k=0;for(i in this._contexts){this._contexts[i].svg().attr("transform","translate(0,"+height*k+")");k+=1}}};PlotManager.prototype.removeContext=function(name){var i,height,k,removed=false,ncontext=0;for(i in this._contexts){if(this._contexts[i].name()==name){this._contexts[i].svg().remove();delete this._contexts[i];removed=true}else{ncontext+=1}}if(removed){i=0;while(i<this._sources.length){if(this._sources[i].context==name){this._sources.splice(i,1)}else{i+=1}}height=(this._height-this._selconfig.height)/ncontext;k=0;for(i in this._contexts){this._contexts[i].height(height);this._contexts[i].svg().attr("transform","translate(0,"+height*k+")");k+=1}}};PlotManager.prototype.addRenderer=function(name,renderer){if(name&&!this._renderer[name]){this._renderer[name]=renderer}};PlotManager.prototype.removeRenderer=function(name){var i;if(this._renderer.hasOwnProperty(name)){delete this._renderer[name];i=0;while(i<this._sources.length){if(this._sources[i].renderer==name){this._sources.splice(i,1)}else{i+=1}}}};PlotManager.prototype.addSource=function(source,context,renderer){if(this._contexts[context]&&this._renderer[renderer]){this._borders=null;this._sources.push({context:context,renderer:renderer,source:source})}};PlotManager.prototype.removeSource=function(name){var i=0;while(i<this._sources.length){if(this._sources[i].source.name()==name){this._sources.splice(i,1)}else{i+=1}}};PlotManager.prototype._onselect=function(){var that;if(!this._onselectHandler){that=this;this._onselectHandler=function(xmin,xmax){that.plotSlice(xmin,xmax)}}return this._onselectHandler};PlotManager.prototype._sliceNotify=function(){var that;if(!this._sliceNotifyHandler){that=this;this._sliceNotifyHandler=function(source){that._bus.publish("slice",source)}}return this._sliceNotifyHandler};PlotManager.prototype._renderOnSlice=function(){var that=this;return function(event,source){var i,sconf,name,context,renderer;for(i in that._sources){sconf=that._sources[i];name=sconf.source.name();if(name==source.name()){context=that._contexts[sconf.context];renderer=that._renderer[sconf.renderer];renderer.render(context,source,true)}}}};return PlotManager}();CryBus=function(){function CryBus(){this.onerror=function(event,data){if(data&&data.error&&console){console.log("CryBus (ERROR): event = "+event+" // error"+data.response||data.error);return false}return true}}CryBus.prototype.subscribe=function(event,fn){if(cry.debug&&console)console.log("CryBus (DEBUG): subscribe event "+event);$(this).bind(event,fn);return this};CryBus.prototype.unsubscribe=function(event){if(cry.debug&&console)console.log("CryBus (DEBUG): unsubscribe event "+event);$(this).unbind(event);return this};CryBus.prototype.publish=function(event,data){if(this.onerror(event,data)){if(cry.debug&&console){var d=data||"none";console.log("CryBus (DEBUG): publish event "+event+" // data = "+d)}$(this).trigger(event,data)}else if(console){var d=data||"none";console.log("CryBus (DEBUG): event not published due to errors // data = "+d)}return this};return CryBus}()})(cry||(cry={}),d3,jQuery);(function(cry){"use strict";cry.Renderer=function(){function Renderer(type){this._class="renderer-"+(Math.random()*Math.pow(2,32)).toString(32);this._classes=["plot",type,this._class].join(" ");this._contexts={}}Renderer.prototype.clear=function(){var i,context;for(i in this._contexts){context=this._contexts[i];context.svg().selectAll("."+this._class).remove()}};Renderer.prototype.render=function(context){this._contexts[context.name()]=context};return Renderer}();cry.SignalRenderer=function(){SignalRenderer.inherits(cry.Renderer);function SignalRenderer(){this.parent.constructor.call(this,"signal")}SignalRenderer.prototype.render=function(context,source,sliced){var alldata,data,plot,style,i,d,x,y,j;this._contexts[context.name()]=context;if(sliced)alldata=source.sliced();else alldata=source.data();if(alldata.length>0){for(i=0;i<alldata.length;i+=1){data=alldata[i].data;style=alldata[i].style;if(!style)style="stroke:black";plot=context.svg().append("path").attr("class",this._classes).attr("style",style);d=new Array(data.length);for(j=1;j<data.length;j+=2){x=context.xScale(data[j-1]);y=context.yScale(data[j]);if(j==1){d[0]="M"+x.toFixed(1);d[1]=y.toFixed(1)}else{d[j-1]="L"+x.toFixed(1);d[j]=y.toFixed(1)}}d=d.join(" ");plot.attr("d",d)}}};return SignalRenderer}();cry.SpikeRenderer=function(){SpikeRenderer.inherits(cry.Renderer);function SpikeRenderer(){this.parent.constructor.call(this,"spike")}SpikeRenderer.prototype.render=function(context,source,sliced){var alldata,data,plot,cheight,sheight,yrange,ystep,markheight,i,mheight,d,x,y,j;this._contexts[context.name()]=context;if(sliced)alldata=source.sliced();else alldata=source.data();context.defs().selectAll("."+this._class).remove();if(alldata.length>0){cheight=context.height();sheight=alldata.length>1?cheight/alldata.length:cheight/2;yrange=context.ymax()-context.ymin();ystep=yrange/alldata.length;markheight=context.height()/alldata.length*.8;for(i=0;i<alldata.length;i+=1){data=alldata[i].data;mheight=SpikeRenderer.addMarker(context.defs(),"spikemarker-"+i,markheight,alldata[i].style);plot=context.svg().append("path").attr("class",this._classes).attr("marker-mid","url(#spikemarker-"+i+")");d=new Array(data.length);for(j=1;j<data.length;j+=2){x=context.xScale(data[j-1]);y=context.yScale(context.ymin()+ystep*i);if(j==1){d[0]="M"+x.toFixed(1);d[1]=y.toFixed(1)}else{d[j-1]="L"+x.toFixed(1);d[j]=y.toFixed(1)}}d=d.join(" ");plot.attr("d",d)}}};SpikeRenderer.addMarker=function(defs,name,height,style){var sty=style;if(!sty)sty="stroke:black;stroke-opacity:0.8";defs.append("marker").attr("id",name).attr("markerWidth",1).attr("markerHeight",height*-1).append("line").attr("stroke-width",1).attr("fill","none").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",height*-1).attr("style",sty)};return SpikeRenderer}()})(cry||(cry={}));(function(cry){"use strict";cry.Source=function(){var scount=0;function Source(name){this._name=name||"source-"+(scount+=1);this._data=[];this._sliced=[];this._dataReady=false;this._slicedReady=false}Source.prototype.name=function(){return this._name};Source.prototype.toString=function(){return"Source: "+this._name};Source.prototype.load=function(){console.log("Source.load(): unimplemented method.")};Source.prototype.data=function(){if(!this._dataReady){this.load()}return this._data};Source.prototype.dataBorders=function(){if(!this._dataReady){this.load()}return _borders(this._data)};Source.prototype.slice=function(start,end,callback){var start,end,border,d,s,startpos,endpos,i,j;if(this._dataReady){this._slicedReady=false;border=this.dataBorders();start=start||border.xmin;end=end||border.xmax;delete this._sliced;this._sliced=new Array(this._data.length);for(i=0;i<this._data.length;i+=1){d=this._data[i];s={style:d.style,name:d.name};startpos=0;endpos=d.data.length-1;for(j=0;j<d.data.length-1;j+=2){if(d.data[j]<start){startpos=j}else if(d.data[j]>end){endpos=j;break}}if(d.data instanceof ArrayBufferView){s.data=d.data.subarray(startpos,endpos)}else{s.data=d.data.slice(startpos,endpos)}this._sliced[i]=s}this._slicedReady=true;if(typeof callback=="function")callback(this)}else{throw"Source: no data available. Use hasData() to avoid this error."}};Source.prototype.sliced=function(){if(this._slicedReady){return this._sliced}throw"Source: no sliced data available. Use hasSliced() to avoid this error."};Source.prototype.sliceBorders=function(){if(this._slicedReady){return _borders(this._sliced)}throw"Source: no sliced data available. Use hasSliced() to avoid this error."};Source.prototype.hasSliced=function(){return this._slicedReady};function _borders(data){var i,d,j,x,y,border={xmin:0,xmax:0,ymin:0,ymax:0};for(i=0;i<data.length;i+=1){d=data[i].data;for(j=1;j<d.length;j+=2){x=d[j-1],y=d[j];if(x<border.xmin)border.xmin=x;else if(x>border.xmax)border.xmax=x;if(y<border.ymin)border.ymin=y;else if(y>border.ymax)border.ymax=y}}return border}return Source}();cry.RandomSignal=function(){RandomSignal.inherits(cry.Source);function RandomSignal(xmax,ymax,size,num){this.parent.constructor.call(this);this._xmax=xmax||100;this._ymax=ymax||1e3;this._size=size||1e3;this._num=num||1}RandomSignal.prototype.load=function(){var i,s,d,x,y,xstep,a1,phi1,o1,a2,phi2,o2,j;if(!this._dataReady){this._data=new Array(this._num);for(i=0;i<this._num;i+=1){s=_randStyle();d=new Float32Array(this._size*2);x=0;xstep=this._xmax/this._size;a1=this._ymax,phi1=Math.random()*Math.PI,o1=Math.PI*((Math.random()*5+5)/this._xmax);a2=Math.random()*this._ymax/5,phi2=Math.random()*Math.PI,o2=Math.PI*((Math.random()*50+50)/this._xmax);for(j=1;j<this._size*2;j+=2){y=Math.sin(x*o1+phi1)*a1+Math.sin(x*o2+phi2)*a2;d[j-1]=x;d[j]=y;x+=xstep}this._data[i]={data:d,style:s}}this._dataReady=true}};function _randStyle(){var rand256=function(){return Math.round(Math.random()*255)};return"stroke:rgb("+rand256()+","+rand256()+","+rand256()+")"}return RandomSignal}();cry.RandomSpikes=function(){RandomSpikes.inherits(cry.Source);function RandomSpikes(xmax,size,num){this.parent.constructor.call(this);this._xmax=xmax||100;this._size=size||1e3;this._num=num||1}RandomSpikes.prototype.load=function(){var i,s,d,x,xstep,j;if(!this._dataReady){this._data=new Array(this._num);for(i=0;i<this._num;i+=1){s=_randStyle();d=new Float32Array(this._size*2);x=0;xstep=this._xmax/this._size*2;for(j=1;j<this._size*2;j+=2){x+=Math.random()*xstep;d[j-1]=x;d[j]=.01}this._data[i]={data:d,style:s}}this._dataReady=true}};function _randStyle(){var rand256=function(){return Math.round(Math.random()*255)};return"stroke:rgb("+rand256()+","+rand256()+","+rand256()+");stroke-opacity:0.85"}return RandomSpikes}()})(cry||(cry={}));