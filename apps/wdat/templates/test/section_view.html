{% extends "test/test_base.html" %}

{% block title %}SectionView Test{% endblock %}

{% block extra_script %}
<script type="text/javascript">
  var init = function() {
    var bus = new WDAT.api.EventBus();
    var api = new WDAT.api.DataAPI('NetworkResource', 'ResourceAdapter', bus);
    var sec = new WDAT.ui.SectionView($('#secv-01'), bus);

    /* create and register handler for save events */
    function doSave(event, data) {
      console.log('EVENT save: ' + JSON.stringify(data));
    }
    bus.subscribe('save', doSave);

    /* Create section form and edit a selectable section */
    var btn_section  = $("#btn-section").button({text: true});
    btn_section.click( function() {
      var id = $('#input-section').val();
      console.log('REQUEST section: ' + id);
      api.get('get-section', {"id": id, "type": "section"});
    });
    var buffer = {};
    var reqcount = 0;
    bus.subscribe('get-section', handleRequestEvents);
    bus.subscribe('get-property', handleRequestEvents);
    bus.subscribe('get-value', handleRequestEvents);
    function handleRequestEvents(event, data) {
      var eventName = event.type;
      console.log('EVENT: ' + eventName + ';COUNT: ' + reqcount + '; EVENT DATA: ' + JSON.stringify(data.response));
      switch (eventName) {
        case 'get-section':
          buffer = {}
          buffer.section = data.response[0];
          api.get('get-property', {"type": "property", "parent": data.response[0].id})
          break;
        case 'get-property':
          buffer.properties = {};
          reqcount = data.response.length
          for (var i in data.response) {
            var prop = data.response[i];
            buffer.properties[prop.id] = {property: prop, values: []};
            api.get('get-value', {"type": "value", "parent": prop.id});
          }
          break;
        case 'get-value':
          reqcount = reqcount - 1;
          for (var i in data.response) {
            var val = data.response[i];
            var parentId = val.parents.parent_property;
            if (buffer.properties.hasOwnProperty(parentId)) {
              buffer.properties[parentId].values.push(val);
            }
          }
          if (reqcount == 0) {
            console.log('SECTION BUFFER: ' + JSON.stringify(buffer, null, 4));
            sec.set(buffer.section);
            var props = []
            for (var i in buffer.properties) {
              props.push(buffer.properties[i]);
            }
            sec.setChildren(props);
          }
          break;
      }
    }
  };
  $(window).load(init);
</script>
{% endblock %}

{% block body %}
<h1>Section View Test</h1>
<div>
  <button id="btn-section">Show Section</button>
  <span>/metadata/section/</span>
  <input type="text" value="1" id="input-section">
</div>
<div id="secv-01" style="border: 1px solid grey"></div>
<div class="event-log"></div>
{% endblock %}
